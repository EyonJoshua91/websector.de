--- 
layout: post
title: Pushing (binary) image data using Node.js and Socket.IO
tags: 
- CoffeeScript
- HTML5
- JavaScript
- Node
status: publish
type: post
published: true
meta: 
  _edit_last: "2"
  _simple_gist: |-
    a:1:{i:1511618;a:3:{s:2:"id";s:7:"1511618";s:11:"description";s:77:"Client-side Roundtrip to send and receive (binary) image data using Socket.IO";s:6:"syntax";s:8057:"<div class="gistem"><div id="gist-1511618" class="gist">
    
            <div class="gist-file">
              <div class="gist-data gist-syntax">
                  <div class="highlight"><pre><div class='line' id='LC1'><br/></div><div class='line' id='LC2'><span class="cm">###</span></div><div class='line' id='LC3'><br/></div><div class='line' id='LC4'><span class="cm">1 SENDING DATA</span></div><div class='line' id='LC5'><br/></div><div class='line' id='LC6'><span class="cm">1.1 get original image data clicking on it</span></div><div class='line' id='LC7'><span class="cm">1.2 get its base64-encoded data</span></div><div class='line' id='LC8'><span class="cm">1.3 emit the data by Socket.IO to server (Node.js)</span></div><div class='line' id='LC9'><br/></div><div class='line' id='LC10'><span class="cm">###</span></div><div class='line' id='LC11'><span class="nx">$</span><span class="p">(</span><span class="s">&quot;.my-image&quot;</span><span class="p">).</span><span class="nx">click</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span></div><div class='line' id='LC12'>	<span class="c1"># get image which was clicked</span></div><div class='line' id='LC13'>	<span class="nv">img = </span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span></div><div class='line' id='LC14'>	<span class="c1"># create base64 encoded image</span></div><div class='line' id='LC15'>	<span class="nv">imgdata = </span><span class="nx">@getBase64Image</span><span class="p">(</span><span class="nx">img</span><span class="p">)</span></div><div class='line' id='LC16'>	<span class="c1"># emit data to clients</span></div><div class='line' id='LC17'>	<span class="nx">@socket</span><span class="p">.</span><span class="nx">emit</span> <span class="s">&#39;onimgdata&#39;</span><span class="p">,</span> <span class="p">{</span>  <span class="nv">width: </span><span class="nx">img</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nv">height: </span><span class="nx">img</span><span class="p">.</span><span class="nx">height</span><span class="p">,</span> <span class="nx">source</span><span class="o">:</span><span class="nx">imgdata</span> <span class="p">}</span></div><div class='line' id='LC18'><br/></div><div class='line' id='LC19'><br/></div><div class='line' id='LC20'><span class="cm">###</span></div><div class='line' id='LC21'><span class="cm">Helper method to get a base64 encoded image data</span></div><div class='line' id='LC22'><span class="cm">Based on http://stackoverflow.com/questions/934012/get-image-data-in-javascript</span></div><div class='line' id='LC23'><span class="cm">###</span></div><div class='line' id='LC24'><span class="nx">getBase64Image</span><span class="o">:</span><span class="nf">(img) -&gt;</span></div><div class='line' id='LC25'>	<span class="c1"># create canvas</span></div><div class='line' id='LC26'>	<span class="nv">canvas = </span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span> <span class="s">&quot;canvas&quot;</span></div><div class='line' id='LC27'>	<span class="nv">canvas.width = </span><span class="nx">img</span><span class="p">.</span><span class="nx">width</span></div><div class='line' id='LC28'>	<span class="nv">canvas.height = </span><span class="nx">img</span><span class="p">.</span><span class="nx">height</span></div><div class='line' id='LC29'>	<span class="nv">context = </span><span class="nx">canvas</span><span class="p">.</span><span class="nx">getContext</span> <span class="s">&quot;2d&quot;</span></div><div class='line' id='LC30'>	<span class="c1"># draw image into canvas</span></div><div class='line' id='LC31'>	<span class="nx">context</span><span class="p">.</span><span class="nx">drawImage</span>   <span class="nx">img</span><span class="p">,</span></div><div class='line' id='LC32'>		<span class="mi">0</span><span class="p">,</span></div><div class='line' id='LC33'>		<span class="mi">0</span></div><div class='line' id='LC34'><br/></div><div class='line' id='LC35'>	<span class="cm">###</span></div><div class='line' id='LC36'><span class="cm">	Get the data-URL formatted image</span></div><div class='line' id='LC37'><span class="cm">	using jpeg format as the type of the image to be returned</span></div><div class='line' id='LC38'><span class="cm">	@see: http://www.w3.org/TR/html5/the-canvas-element.html</span></div><div class='line' id='LC39'><span class="cm">	###</span></div><div class='line' id='LC40'>	<span class="nv">data = </span><span class="nx">canvas</span><span class="p">.</span><span class="nx">toDataURL</span> <span class="s">&quot;image/jpeg&quot;</span></div><div class='line' id='LC41'><br/></div><div class='line' id='LC42'>	<span class="c1">#return data</span></div><div class='line' id='LC43'>	<span class="nx">data</span></div><div class='line' id='LC44'><br/></div><div class='line' id='LC45'><span class="cm">###</span></div><div class='line' id='LC46'><br/></div><div class='line' id='LC47'><span class="cm">2 RECEIVING DATA + DISPLAY IMAGE</span></div><div class='line' id='LC48'><span class="cm">2.1 listen to &quot;showimgdata&quot; event sent from server (Node.js)</span></div><div class='line' id='LC49'><span class="cm">2.2 push data to HTML image</span></div><div class='line' id='LC50'><br/></div><div class='line' id='LC51'><span class="cm">###</span></div><div class='line' id='LC52'><br/></div><div class='line' id='LC53'><span class="nx">@socket</span><span class="p">.</span><span class="kc">on</span> <span class="s">&#39;showimgdata&#39;</span><span class="p">,</span> <span class="nf">(data) -&gt;</span></div><div class='line' id='LC54'>	<span class="c1">#get image</span></div><div class='line' id='LC55'>	<span class="nv">img = </span><span class="nx">$</span><span class="p">(</span><span class="s">&#39;#show-img&#39;</span><span class="p">).</span><span class="nx">get</span> <span class="mi">0</span></div><div class='line' id='LC56'>	<span class="nx">message</span></div><div class='line' id='LC57'>	<span class="k">try</span></div><div class='line' id='LC58'>		<span class="c1"># set data for image</span></div><div class='line' id='LC59'>		<span class="nv">img.width = </span><span class="nx">data</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span></div><div class='line' id='LC60'>		<span class="nv">img.height = </span><span class="nx">data</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span></div><div class='line' id='LC61'>		<span class="nv">img.src = </span><span class="nx">data</span><span class="p">.</span><span class="nx">source</span><span class="p">;</span></div><div class='line' id='LC62'><br/></div><div class='line' id='LC63'>		<span class="nv">message = </span><span class="s">&#39;&#39;</span></div><div class='line' id='LC64'><br/></div><div class='line' id='LC65'>	<span class="k">catch</span> <span class="nx">error</span></div><div class='line' id='LC66'>		<span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">error</span></div><div class='line' id='LC67'>		<span class="nv">message = </span><span class="s">&#39;error receiving image data...&#39;</span></div><div class='line' id='LC68'><br/></div><div class='line' id='LC69'><br/></div></pre></div>
              </div>
    
              <div class="gist-meta">
                <a href="https://gist.github.com/raw/1511618/c17014cf946ef02d903dc1c7990ce70b0e4ff22e/sending-receiving-base64encodeImage.coffee" style="float:right;">view raw</a>
                <a href="https://gist.github.com/1511618#file_sending_receiving_base64encode_image.coffee" style="float:right;margin-right:10px;color:#666">sending-receiving-base64encodeImage.coffee</a>
                <a href="https://gist.github.com/1511618">This Gist</a> is brought to you using <a href="http://en.bainternet.info/2011/simple-gist-embed"><small>Simple Gist Embed</small></a>.
              </div>
            </div>
    </div>
    </div>";}}
  _oembed_0f5a1a583d5dca3763b2e4885997550e: <iframe src="http://player.vimeo.com/video/34076718" width="500" height="313" frameborder="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>
  _oembed_c6f4d02c7284ef5316ab98c27c1afafe: <iframe src="http://player.vimeo.com/video/34076718" width="500" height="313" frameborder="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>
  _oembed_28afb71b55e740d0ebe40b0cc5799438: <iframe src="http://player.vimeo.com/video/34076718" width="640" height="400" frameborder="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>
---
These days I'm playing around with <a href="http://nodejs.org">Node.js</a> and <a href="http://socket.io">Socket.IO</a>. One of my goal was to push (binary) image data to clients (browser) in real time using WebSockets.

<!--more-->
<h2>Demo (Video on Vimeo)</h2>
http://vimeo.com/34076718
<h2>Behind the scenes</h2>
The simple demo runs with <a href="http://nodejs.org">Node.js</a> (<a href="http://expressjs.com/">Express</a>) and <a href="http://expressjs.com/">Socket.IO</a>. It generates its HTML code using <a href="https://github.com/visionmedia/jade">Jade</a> templates and <a href="http://learnboost.github.com/stylus/">Stylus</a> (CSS). The code is written in <a href="http://jashkenas.github.com/coffee-script/">CoffeeScript</a>.
<h2>Limitation of pushing binary data</h2>
At the time of writing this post sending and receiving binary data using WebSockets <a href="http://en.wikipedia.org/wiki/Comparison_of_WebSocket_implementations">are very limited by current browser</a>.

To avoid lack of supporting binary messages by browser all image data have to be encoded in base64 before emitting the message. To do that just draw the image within a Canvas and send the data using Canvas' <a href="http://www.w3.org/TR/html5/the-canvas-element.html#dom-canvas-todataurl ">toDataURL()</a> over the wire.

Here is a simple roundtrip on client-side (You will find all code of this demo here: <a href="https://github.com/sectore/node-socket.io-push-image-demo">https://github.com/sectore/node-socket.io-push-image-demo</a>):

[gist id="1511618"]

The disadvantage of this solution is that "<i><a href="http://www.html5rocks.com/en/mobile/mobifying.html#toc-optimizations-requests">Base64 encoding adds ~30%+ of size to the image</a></i>" (Quote by Eric Bidelman / Developer Relations, Google: <a href="http://www.html5rocks.com/en/mobile/mobifying.html">"Mobifying" Your HTML5 Site</a>).
<h2>Source code</h2>
<a href="https://github.com/sectore/node-socket.io-push-image-demo">All source code</a> and its installation instruction available at <a href="https://github.com/sectore/node-socket.io-push-image-demo">GitHub</a>.

Have fun!

-Jens
